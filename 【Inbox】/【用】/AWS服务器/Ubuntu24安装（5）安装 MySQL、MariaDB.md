AWS服务器#Ubuntu24安装（5）安装 MySQL、MariaDB

httplocalhostdiscuz_pkbforum.phpmod=viewthread&tid=106

(出处 知识库)

|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| \|   \|<br>\|---\|<br>\|**  <br>===安装 MariaDB**<br><br>sudo apt install mariadb-server -y<br><br>  <br><br>**查看运行状态**<br><br>sudo systemctl status mariadb<br><br>  <br><br>**重新启动**<br><br>sudo systemctl restart mariadb<br><br>sudo systemctl start mariadb<br><br>sudo systemctl stop mariadb<br><br>  <br><br>**开机自启**<br><br>sudo systemctl enable mariadb<br><br>  <br>  <br>  <br><br>**（可选）运行安全脚本**<br><br>sudo mysql_secure_installation<br><br>  <br>  <br>  <br><br>**配置文件（修改端口）**<br><br>vi /etc/mysql/mariadb.conf.d/50-server.cnf<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437251579.jpeg)  <br>  <br><br>**进入MySQL命令行，添加远程用户root（含密码）**<br><br>mysql -u root -p<br><br>mysql> CREATE USER 'root'@'%' IDENTIFIEDBY 'weiwei2544';<br><br>mysql> GRANTALL PRIVILEGES ON*.* TO 'root'@'%' WITH GRANT OPTION;<br><br>mysql> FLUSH PRIVILEGES;<br><br>  <br><br>**修改MySQL用户的密码**<br><br>mysql -u root -p<br><br>mysql> ALTERUSER 'root'@'localhost' IDENTIFIED BY 'weiwei2544';<br><br>mysql> FLUSHPRIVILEGES;<br><br>  <br>  <br><br>**允许远程连接**<br><br>**编辑配置文件**<br><br>vi /etc/mysql/mariadb.conf.d/50-server.cnf  <br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437251885.jpeg)<br><br>  <br><br>**修改数据库目录**<br><br>sudo systemctl stop mariadb<br><br>  <br><br>**修改配置文件**<br><br>vi /etc/mysql/mariadb.conf.d/50-server.cnf<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437252117.jpeg)  <br>  <br><br>**复制数据库**<br><br>mkdir -p /wwwroot/lib/mysql/<br><br>sudo rsync -av /var/lib/mysql/ /wwwroot/lib/mysq/<br><br>mv /var/lib/mysql/ /wwwroot/lib/mysq/<br><br>  <br><br>**？？？如果启用了AppArmor，更新其配置以允许 MariaDB 访问新目录**<br><br>vi /etc/apparmor.d/tunables/alias<br><br>添加<br><br>alias /var/lib/mysql/ -> /wwwroot/lib/mysql/,<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437252374.jpeg)  <br><br>vi /etc/apparmor.d/usr.sbin.mysqld<br><br>/wwwroot/lib/mysql/ r,<br><br>/wwwroot/lib/mysql/** rwk,<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437252581.jpeg)  <br>  <br><br>vi /etc/apparmor.d/abstractions/mysql<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437252818.jpeg)  <br>  <br><br>然后重新加载 AppArmor<br><br>systemctl restart apparmor<br><br>  <br>  <br><br>**修改 MySQL systemd 服务MySQL 的 systemd 可能会忽略 mysqld.cnf 配置，需要手动指定 datadir：**<br><br>sudo systemctl edit mysql添加：  <br>[Service]ExecStart=ExecStart=/usr/sbin/mysqld --datadir=/wwwroot/lib/mysql保存后，重新加载 systemd：  <br>sudo systemctl daemon-reload  <br>  <br>  <br>  <br>  <br>  <br>  <br><br>**清理旧数据（可选）**<br><br>sudo rm -rf /var/lib/mysql/<br><br>  <br><br>**安装phpMyAdmin**<br><br>aptinstall phpMyAdmin -y<br><br>  <br><br>**配置 ApachephpMyAdmin 可能没有自动配置 Apache，因此你需要手动创建一个配置文件：**<br><br>sudo nano/etc/apache2/conf-available/phpmyadmin.conf<br><br>Alias /phpmyadmin /usr/share/phpmyadmin<br><br><Directory /usr/share/phpmyadmin><br><br>   Options SymLinksIfOwnerMatch<br><br>   DirectoryIndex index.php<br><br>   <IfModule mod_php.c><br><br>       <FilesMatch ".+\.php$"><br><br>           SetHandler application/x-httpd-php<br><br>       </FilesMatch><br><br>       php_admin_value upload_max_filesize 50M<br><br>       php_admin_value post_max_size 50M<br><br>       php_admin_value max_execution_time 300<br><br>       php_admin_value max_input_time 300<br><br>   </IfModule><br><br>   Require all granted<br><br></Directory><br><br>  <br>  <br>  <br><br>**建立软链到/wwwroot/html/ibrainbook**<br><br>sudo ln -s /usr/share/phpmyadmin /wwwroot/html/ibrainbook/phpMyAdmin<br><br>  <br><br>**启用phpmyadmin配置**<br><br>sudoa2enconf phpmyadmin<br><br>sudosystemctl reload apache2<br><br>  <br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437253022.jpeg)  <br>  <br>  <br><br>**（可选）修改phpMyAdmin配置**<br><br>phpMyAdmin默认也不允许空密码登录。你需要修改其配置文件以允许空密码<br><br>nano/etc/phpmyadmin/config.inc.php<br><br>  <br>  <br>  <br><br>**导出数据库数据**<br><br>mysqldump-u [user] -p [db_name] > [export_the_db.sql]<br><br>  <br>  <br>  <br><br>**===（放弃！有BUG！）安装MySQL**<br><br>Ubuntu 24.04 的默认软件仓库包含 MySQL，因此可以直接安装<br><br>sudo apt install mysql-server -y<br><br>  <br>  <br><br>**查看运行状态**<br><br>systemctl status mysql.service<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437253239.jpeg)  <br>  <br><br>**重启MySQL**<br><br>service mysql restart<br><br>service mysql start<br><br>service mysql stop<br><br>  <br><br>**MySQL 开机自启**<br><br>systemctl enablemysql<br><br>  <br>  <br>  <br>  <br><br>**获取版本**<br><br>apt list --installed \\ | grep -E 'mysql-(client\\ | server)'<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437253524.jpeg)  <br>  <br>  <br><br>**查看数据目录**<br><br>mysql -u root -p -e "SELECT@@datadir;"<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437253758.jpeg)  <br>  <br><br>**查看MySQL错误日志**<br><br>cat /var/log/mysql/error.log<br><br>  <br>  <br><br>**（可选）运行安全配置向导**<br><br>sudo mysql_secure_installation<br><br>根据提示进行以下操作：<br><br>  <br><br>- 设置 root 用户密码（如果有提示）<br>- 移除匿名用户 (建议选择 Y)<br>- 禁止 root 远程登录 (因需要远程管理，选择 N)<br>- 移除测试数据库 (建议选择 Y)<br>- 重新加载权限表 (选择 Y)<br><br>  <br>  <br>  <br>  <br>  <br><br>**进入MySQL命令行，添加远程用户root（含密码）**<br><br>mysql -u root -p<br><br>mysql> CREATE USER 'root'@'%' IDENTIFIEDBY 'weiwei2544';<br><br>mysql> GRANTALL PRIVILEGES ON*.* TO 'root'@'%' WITH GRANT OPTION;<br><br>mysql> FLUSH PRIVILEGES;<br><br>  <br><br>**修改MySQL用户的密码**<br><br>mysql -u root -p<br><br>mysql> ALTERUSER 'root'@'localhost' IDENTIFIED BY 'weiwei2544';<br><br>mysql> FLUSHPRIVILEGES;<br><br>  <br>  <br>  <br><br>**配置文件，允许远程连接**<br><br>vi /etc/mysql/mysql.conf.d/mysqld.cnf<br><br>找到以下行：<br><br>bind-address = 127.0.0.1<br><br>改成：<br><br>bind-address = 0.0.0.0<br><br>  <br><br>**(可选) 允许MySQL 端口（默认 3306，3399）通过防火墙**<br><br>sudo ufw allow 3306/tcp<br><br>sudo ufw allow 3399/tcp<br><br>  <br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437253987.jpeg)  <br>  <br>  <br><br>**（可选）编辑MySQL配置文件，修改数据库目录**<br><br>！！！[https://blog.csdn.net/qq_33187368/article/details/129832763](https://blog.csdn.net/qq_33187368/article/details/129832763)<br><br>vi /etc/mysql/mysql.conf.d/mysqld.cnf<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437254193.jpeg)  <br>  <br><br>**停止MySQL**<br><br>sudo systemctl stop mysql<br><br>  <br>  <br><br>**复制数据库数据**<br><br>rsync -av /var/lib/mysql/ /wwwroot/lib/mysql/<br><br>为防止误操作，可以先备份旧目录<br><br>rm -R /var/lib/mysql.bak<br><br>mv /var/lib/mysql /var/lib/mysql.bak<br><br>mv /var/lib/mysql.bak /var/lib/mysq<br><br>  <br><br>**配置 AppArmor 规则Ubuntu 使用 AppArmor 限制 MySQL 访问特定目录，所以必须修改规则。**<br><br>vi /etc/apparmor.d/tunables/alias<br><br>添加<br><br>alias /var/lib/mysql/ -> /wwwroot/lib/mysql/,<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437254418.jpeg)  <br><br>vi /etc/apparmor.d/usr.sbin.mysqld<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437254640.jpeg)  <br><br>vi /etc/apparmor.d/abstractions/mysql<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437254931.jpeg)  <br>  <br><br>然后重新加载 AppArmor<br><br>systemctl restart apparmor<br><br>  <br>  <br><br>**修改 MySQL systemd 服务MySQL 的 systemd 可能会忽略 mysqld.cnf 配置，需要手动指定 datadir：**<br><br>sudo systemctl edit mysql添加：  <br>[Service]ExecStart=ExecStart=/usr/sbin/mysqld --datadir=/wwwroot/lib/mysql保存后，重新加载 systemd：  <br>sudo systemctl daemon-reload  <br>  <br><br>**修复权限并启动 MySQL**<br><br>chown -R mysql:mysql /wwwroot/lib<br><br>sudo systemctl start mysql<br><br>sudo systemctl status mysql<br><br>  <br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437255213.jpeg)  <br>  <br>  <br>  <br><br>**===[BUG#MySQL8.0.41#PHP Fatal error:  Uncaught mysqli_sql_exception: Access deniedfor user 'root'@'localhost']**<br><br>服务器：Ubuntu24.04; PHP8.3.6;MySQL8.0.41<br><br>cat /var/log/apache2/error.log<br><br>![Ubuntu24安装（5）安装 MySQL、MariaDB](https://repo.in4tree.com/2026/01/14_1768437255477.jpeg)  <br><br>MySQLi服务器PHP8.3.6P# 远程访问数据库127.0.0.1.# =》失败！SQLSTATE[HY000] [1698] Access deniedfor user 'root'@'localhost'<br><br>MySQLi：本地PHP8.4.4# 远程访问数据库54.148.142.35# =》 OK！<br><br>MySQLi：服务器PHP8.3.6# 远程访问数据库54.148.142.35# =》失败！<br><br>PDO：本地PHP8.4.4# 远程访问数据库54.148.142.35# =》OK！<br><br>PDO：服务器PHP8.3.6# 远程访问数据库54.148.142.35# =》失败！连接失败: SQLSTATE[HY000] [2002] Connection timed out<br><br>PDO：服务器PHP8.3.6# 远程访问数据库127.0.0.1.# =》失败！SQLSTATE[HY000] [1698] Access deniedfor user 'root'@'localhost'<br><br>换Ubuntu各版本和PHP各版本后问题依旧！<br><br>AWS Linux 2023+MySQL8则正常<br><br>  <br>**结论：Ubuntu 24，无论是否移动数据库目录或网站根目录，只要PHP代码在服务器用127.0.0.1访问数据库，就出现该错误！暂时解决：放弃MySQL！使用MariaDB即可**\| |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |